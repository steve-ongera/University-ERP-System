{% extends 'base.html' %}
{% load static %}

{% block content %}

<div class="row mt-3">
    <div class="col-md-12">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
            <i class="bi {% if message.tags == 'success' %}bi-check-circle{% else %}bi-exclamation-triangle{% endif %} me-2"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
</div>

<div class="container onprintContainer">
    <!-- Course Header -->
    <div class="row p-3">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h2 class="fw-bold">{{ enrollment.course.name }}</h2>
                        <p class="text-muted mb-1">
                            <span class="badge bg-primary">{{ enrollment.course.code }}</span> | 
                            <span class="badge bg-{% if enrollment.course.course_type == 'core' %}danger{% elif enrollment.course.course_type == 'elective' %}success{% else %}secondary{% endif %}">
                                {{ enrollment.course.get_course_type_display }}
                            </span> |
                            <span class="badge bg-info">{{ enrollment.course.credit_hours }} Credits</span>
                        </p>
                        <p class="mb-0">
                            <i class="bi bi-building me-1"></i>{{ enrollment.course.department.faculty.name }} - {{ enrollment.course.department.name }}
                        </p>
                        {% if enrollment.lecturer %}
                        <p class="mb-0">
                            <i class="bi bi-person-circle me-1"></i>{{ enrollment.lecturer.user.get_full_name }} ({{ enrollment.lecturer.academic_rank|title }})
                        </p>
                        {% endif %}
                        <p class="mb-0">
                            <i class="bi bi-calendar me-1"></i>{{ enrollment.semester.academic_year.year }} - Semester {{ enrollment.semester.semester_number }}
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        {% if grade %}
                        <div class="d-inline-block bg-light rounded p-3">
                            <h4 class="mb-1 text-primary">{{ grade.grade|default:"N/A" }}</h4>
                            <small class="text-muted">Current Grade</small>
                            {% if grade.grade_points %}
                            <br><small class="text-muted">{{ grade.grade_points }} GPA</small>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="d-inline-block bg-light rounded p-3">
                            <h4 class="mb-1 text-muted">N/A</h4>
                            <small class="text-muted">No Grade Yet</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="btn-group float-end">
                            <a href="{% url 'student_dashboard' %}" class="btn btn-outline-primary">
                                <i class="bi bi-arrow-left"></i> Back to Dashboard
                            </a>
                            <button class="btn btn-outline-info" onclick="window.print()">
                                <i class="bi bi-printer"></i> Print
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row p-3">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-2 border-end">
                            <h5 class="text-primary">{{ stats.total_assignments }}</h5>
                            <p class="small text-muted mb-0">Total Assignments</p>
                        </div>
                        <div class="col-md-2 border-end">
                            <h5 class="text-success">{{ stats.submitted_count }}</h5>
                            <p class="small text-muted mb-0">Submitted</p>
                        </div>
                        <div class="col-md-2 border-end">
                            <h5 class="text-warning">{{ stats.pending_count }}</h5>
                            <p class="small text-muted mb-0">Pending</p>
                        </div>
                        <div class="col-md-2 border-end">
                            <h5 class="text-danger">{{ stats.overdue_count }}</h5>
                            <p class="small text-muted mb-0">Overdue</p>
                        </div>
                        <div class="col-md-2 border-end">
                            <h5 class="text-info">{{ stats.notes_count }}</h5>
                            <p class="small text-muted mb-0">Course Notes</p>
                        </div>
                        <div class="col-md-2">
                            <h5 class="text-secondary">{{ enrollment.course.level }}</h5>
                            <p class="small text-muted mb-0">Course Level</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Course Information -->
    <div class="row p-3">
        <div class="col-md-8">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title fw-bold">Course Information</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-2"><strong>Lecture Hours:</strong> {{ enrollment.course.lecture_hours }}h</p>
                            <p class="mb-2"><strong>Tutorial Hours:</strong> {{ enrollment.course.tutorial_hours }}h</p>
                            <p class="mb-2"><strong>Practical Hours:</strong> {{ enrollment.course.practical_hours }}h</p>
                            <p class="mb-2"><strong>Total Contact Hours:</strong> {{ enrollment.course.total_contact_hours }}h</p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-2"><strong>Enrollment Date:</strong> {{ enrollment.enrollment_date|date:"M d, Y" }}</p>
                            <p class="mb-2"><strong>Status:</strong> 
                                <span class="badge bg-{% if enrollment.is_active %}success{% else %}secondary{% endif %}">
                                    {% if enrollment.is_active %}Active{% else %}Inactive{% endif %}
                                </span>
                                {% if enrollment.is_repeat %}
                                <span class="badge bg-warning">Repeat</span>
                                {% endif %}
                            </p>
                            {% if lecturer_assignment and lecturer_assignment.lecture_venue %}
                            <p class="mb-2"><strong>Venue:</strong> {{ lecturer_assignment.lecture_venue }}</p>
                            {% endif %}
                            {% if lecturer_assignment and lecturer_assignment.lecture_time %}
                            <p class="mb-2"><strong>Schedule:</strong> {{ lecturer_assignment.lecture_time }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% if enrollment.course.description %}
                    <div class="mt-3">
                        <h6 class="fw-bold">Description</h6>
                        <p class="text-muted">{{ enrollment.course.description }}</p>
                    </div>
                    {% endif %}
                    {% if enrollment.course.learning_outcomes %}
                    <div class="mt-3">
                        <h6 class="fw-bold">Learning Outcomes</h6>
                        <p class="text-muted">{{ enrollment.course.learning_outcomes }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title fw-bold">Academic Progress</h5>
                    <div class="progress mb-3" style="height: 20px;">
                        {% if stats.total_assignments > 0 %}
                        {% widthratio stats.submitted_count stats.total_assignments 100 as progress %}
                        <div class="progress-bar bg-success" style="width: {{ progress }}%">
                            {{ progress }}%
                        </div>
                        {% endif %}
                    </div>
                    <p class="small text-muted mb-3">Assignment Completion Progress</p>
                    
                    {% if grade %}
                    <div class="mt-3">
                        <h6 class="fw-bold">Grade Breakdown</h6>
                        {% if grade.continuous_assessment %}
                        <p class="mb-1"><small>CAT (40%): {{ grade.continuous_assessment }}/40</small></p>
                        {% endif %}
                        {% if grade.final_exam %}
                        <p class="mb-1"><small>Final Exam (60%): {{ grade.final_exam }}/60</small></p>
                        {% endif %}
                        {% if grade.total_marks %}
                        <p class="mb-1"><strong>Total: {{ grade.total_marks }}/100</strong></p>
                        {% endif %}
                        {% if grade.percentage_score %}
                        <p class="mb-1"><small>Percentage: {{ grade.percentage_score|floatformat:1 }}%</small></p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <div class="row p-3">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="courseDetailTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="assignments-tab" data-bs-toggle="tab" data-bs-target="#assignments" type="button" role="tab">
                                <i class="bi bi-journal-text me-1"></i>Assignments ({{ stats.total_assignments }})
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button" role="tab">
                                <i class="bi bi-file-earmark-text me-1"></i>Course Notes ({{ stats.notes_count }})
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="announcements-tab" data-bs-toggle="tab" data-bs-target="#announcements" type="button" role="tab">
                                <i class="bi bi-megaphone me-1"></i>Announcements
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="courseDetailTabsContent">
                        <!-- Assignments Tab -->
                        <div class="tab-pane fade show active" id="assignments" role="tabpanel">
                            {% if assignments %}
                            <div class="row">
                                {% for assignment in assignments %}
                                <div class="col-md-6 mb-3">
                                    <div class="card border-left-{% if assignment.is_submitted %}success{% elif assignment.is_overdue %}danger{% else %}primary{% endif %}">
                                        <div class="card-header d-flex justify-content-between">
                                            <h6 class="mb-0">{{ assignment.title|truncatechars:25 }}</h6>
                                            <div>
                                                {% if assignment.is_submitted %}
                                                <span class="badge bg-success">Submitted</span>
                                                {% elif assignment.is_overdue %}
                                                <span class="badge bg-danger">Overdue</span>
                                                {% else %}
                                                <span class="badge bg-warning">Pending</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <p class="small text-muted mb-2">{{ assignment.get_assignment_type_display }}</p>
                                            <p class="card-text small">{{ assignment.description|truncatechars:100 }}</p>
                                            
                                            <div class="row text-center mt-3">
                                                <div class="col-4">
                                                    <small class="text-muted">Total Marks</small>
                                                    <h6>{{ assignment.total_marks }}</h6>
                                                </div>
                                                <div class="col-4">
                                                    <small class="text-muted">Weight</small>
                                                    <h6>{{ assignment.weight_percentage }}%</h6>
                                                </div>
                                                <div class="col-4">
                                                    <small class="text-muted">
                                                        {% if assignment.student_submission and assignment.student_submission.marks_obtained %}
                                                        Your Score
                                                        {% else %}
                                                        Status
                                                        {% endif %}
                                                    </small>
                                                    <h6>
                                                        {% if assignment.student_submission and assignment.student_submission.marks_obtained %}
                                                        {{ assignment.student_submission.marks_obtained }}/{{ assignment.total_marks }}
                                                        {% else %}
                                                        -
                                                        {% endif %}
                                                    </h6>
                                                </div>
                                            </div>
                                            
                                            <hr>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <small class="text-muted">
                                                    <i class="bi bi-calendar me-1"></i>Due: {{ assignment.due_date|date:"M d, Y H:i" }}
                                                </small>
                                                <div class="btn-group btn-group-sm">
                                                    <a href="{% url 'assignment_detail' assignment.id %}" class="btn btn-outline-primary">
                                                        <i class="bi bi-eye"></i> View
                                                    </a>
                                                    {% if not assignment.is_submitted and assignment.can_submit %}
                                                    <a href="{% url 'assignment_detail' assignment.id %}" class="btn btn-outline-success">
                                                        <i class="bi bi-upload"></i> Submit
                                                    </a>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            
                                            {% if assignment.student_submission %}
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    {% if assignment.student_submission.is_submitted %}
                                                    Submitted on: {{ assignment.student_submission.submitted_date|date:"M d, Y H:i" }}
                                                    {% if assignment.student_submission.is_late %}
                                                    <span class="text-danger">(Late)</span>
                                                    {% endif %}
                                                    {% else %}
                                                    Draft saved
                                                    {% endif %}
                                                </small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="bi bi-journal-text display-1 text-muted"></i>
                                <h5 class="text-muted mt-3">No Assignments Yet</h5>
                                <p class="text-muted">No assignments have been posted for this course yet.</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Course Notes Tab -->
                        <div class="tab-pane fade" id="notes" role="tabpanel">
                            {% if course_notes %}
                            <div class="row">
                                {% for note in course_notes %}
                                <div class="col-md-4 mb-3">
                                    <div class="card h-100">
                                        <div class="card-header d-flex justify-content-between">
                                            <small class="text-muted">{{ note.get_note_type_display }}</small>
                                            {% if note.week_number %}
                                            <span class="badge bg-secondary">Week {{ note.week_number }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="card-body">
                                            <h6 class="card-title">{{ note.title }}</h6>
                                            {% if note.topic %}
                                            <p class="small text-primary mb-2"><strong>{{ note.topic }}</strong></p>
                                            {% endif %}
                                            {% if note.description %}
                                            <p class="card-text small">{{ note.description|truncatechars:80 }}</p>
                                            {% endif %}
                                            
                                            <div class="mt-3">
                                                <p class="small text-muted mb-1">
                                                    <i class="bi bi-calendar me-1"></i>{{ note.posted_date|date:"M d, Y" }}
                                                </p>
                                                <p class="small text-muted mb-1">
                                                    <i class="bi bi-download me-1"></i>{{ note.download_count }} downloads
                                                </p>
                                                {% if note.file_size %}
                                                <p class="small text-muted mb-1">
                                                    <i class="bi bi-file-earmark me-1"></i>{{ note.file_size|filesizeformat }}
                                                </p>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="card-footer">
                                            <div class="d-grid gap-2">
                                                <a href="{{ note.notes_file.url }}" class="btn btn-outline-primary btn-sm" target="_blank">
                                                    <i class="bi bi-eye me-1"></i>Preview
                                                </a>
                                                <a href="{% url 'download_notes' note.id %}" class="btn btn-success btn-sm">
                                                    <i class="bi bi-download me-1"></i>Download
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="bi bi-file-earmark-text display-1 text-muted"></i>
                                <h5 class="text-muted mt-3">No Course Notes</h5>
                                <p class="text-muted">No course notes have been uploaded yet.</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Announcements Tab -->
                        <div class="tab-pane fade" id="announcements" role="tabpanel">
                            {% if announcements %}
                            <div class="list-group">
                                {% for announcement in announcements %}
                                <div class="list-group-item {% if announcement.is_urgent %}border-warning{% endif %}">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="mb-1">
                                            {% if announcement.is_urgent %}
                                            <i class="bi bi-exclamation-triangle text-warning me-1"></i>
                                            {% endif %}
                                            {{ announcement.title }}
                                        </h6>
                                        <small class="text-muted">{{ announcement.posted_date|timesince }} ago</small>
                                    </div>
                                    <p class="mb-1">{{ announcement.message }}</p>
                                    <small class="text-muted">Related to: {{ announcement.assignment.title }}</small>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="bi bi-megaphone display-1 text-muted"></i>
                                <h5 class="text-muted mt-3">No Announcements</h5>
                                <p class="text-muted">No announcements have been posted for this course.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tabs
    const tabElms = document.querySelectorAll('button[data-bs-toggle="tab"]');
    tabElms.forEach(tabEl => {
        tabEl.addEventListener('click', function(event) {
            event.preventDefault();
            const tab = new bootstrap.Tab(this);
            tab.show();
        });
    });
});
</script>

<style>
@media print {
    .btn, .nav-tabs, .card-footer {
        display: none !important;
    }
    
    .onprintContainer {
        margin: 0 !important;
        padding: 0 !important;
    }
    
    .card {
        border: none !important;
        box-shadow: none !important;
    }
}

.border-left-primary {
    border-left: 4px solid #007bff !important;
}

.border-left-success {
    border-left: 4px solid #28a745 !important;
}

.border-left-danger {
    border-left: 4px solid #dc3545 !important;
}

.card:hover {
    transform: translateY(-2px);
    transition: transform 0.2s ease;
}

.progress {
    background-color: #e9ecef;
}

.list-group-item.border-warning {
    border-color: #ffc107 !important;
    background-color: #fff3cd;
}
</style>

{% endblock %}