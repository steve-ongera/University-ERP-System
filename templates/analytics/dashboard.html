{% extends 'admin_base.html' %}
{% load static %}

{% block content %}

<div class="message-container" id="system-messages">
    {% for message in messages %}
    <div class="alert-message alert-{{ message.tags }}">
        {{ message }}
        <span class="close-message">&times;</span>
    </div>
    {% endfor %}
</div>

<div class="container onprintContainer">
    <!-- Dashboard Header -->
    <div class="row p-3">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h2 class="fw-bold">University Analytics Dashboard</h2>
                        <p class="text-muted mb-1">
                            <span class="badge bg-primary">Academic Year: {{ current_academic_year.year|default:"N/A" }}</span> | 
                            <span class="badge bg-info">Current Semester: {{ current_semester.semester_number|default:"N/A" }}</span>
                        </p>
                        <p class="mb-0">
                            <i class="bi bi-calendar me-1"></i>Last Updated: {{ current_academic_year.start_date|date:"M d, Y"|default:"N/A" }}
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="d-inline-block bg-light rounded p-3">
                            <h4 class="mb-1 text-primary">{{ total_students }}</h4>
                            <small class="text-muted">Active Students</small>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="btn-group float-end">
                            <button class="btn btn-outline-primary" id="refreshData">
                                <i class="bi bi-arrow-clockwise"></i> Refresh Data
                            </button>
                            <button class="btn btn-outline-info" onclick="window.print()">
                                <i class="bi bi-printer"></i> Print Report
                            </button>
                            <button class="btn btn-outline-success" id="exportData">
                                <i class="bi bi-download"></i> Export
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row p-3">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-2 border-end">
                            <h5 class="text-primary">{{ total_students }}</h5>
                            <p class="small text-muted mb-0">Total Students</p>
                        </div>
                        <div class="col-md-2 border-end">
                            <h5 class="text-success">{{ total_lecturers }}</h5>
                            <p class="small text-muted mb-0">Active Lecturers</p>
                        </div>
                        <div class="col-md-2 border-end">
                            <h5 class="text-warning">{{ total_courses }}</h5>
                            <p class="small text-muted mb-0">Active Courses</p>
                        </div>
                        <div class="col-md-2 border-end">
                            <h5 class="text-danger">{{ total_programmes }}</h5>
                            <p class="small text-muted mb-0">Programmes</p>
                        </div>
                        <div class="col-md-2 border-end">
                            <h5 class="text-info">{{ total_faculties }}</h5>
                            <p class="small text-muted mb-0">Faculties</p>
                        </div>
                        <div class="col-md-2">
                            <h5 class="text-secondary" id="occupancyRate">--%</h5>
                            <p class="small text-muted mb-0">Hostel Occupancy</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics Overview -->
    <div class="row p-3">
        <div class="col-md-8">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title fw-bold">Academic Overview</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-primary text-white mb-2">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 id="enrollmentCount">Loading...</h4>
                                            <p class="mb-0">Current Enrollments</p>
                                        </div>
                                        <i class="bi bi-people-fill display-4"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-success text-white mb-2">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 id="avgGPA">Loading...</h4>
                                            <p class="mb-0">Average GPA</p>
                                        </div>
                                        <i class="bi bi-award-fill display-4"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-info text-white mb-2">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 id="completionRate">Loading...</h4>
                                            <p class="mb-0">Assignment Completion</p>
                                        </div>
                                        <i class="bi bi-clipboard-check-fill display-4"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-warning text-white mb-2">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 id="libraryUsage">Loading...</h4>
                                            <p class="mb-0">Library Transactions</p>
                                        </div>
                                        <i class="bi bi-book-fill display-4"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title fw-bold">Student Distribution</h5>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="genderDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Charts Section -->
    <div class="row p-3">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="analyticsTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="enrollment-tab" data-bs-toggle="tab" data-bs-target="#enrollment" type="button" role="tab">
                                <i class="bi bi-graph-up me-1"></i>Enrollment Analytics
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button" role="tab">
                                <i class="bi bi-trophy me-1"></i>Academic Performance
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="financial-tab" data-bs-toggle="tab" data-bs-target="#financial" type="button" role="tab">
                                <i class="bi bi-cash-stack me-1"></i>Financial Analytics
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="hostel-tab" data-bs-toggle="tab" data-bs-target="#hostel" type="button" role="tab">
                                <i class="bi bi-house me-1"></i>Accommodation
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button" role="tab">
                                <i class="bi bi-calendar-check me-1"></i>Attendance
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="analyticsTabContent">
                        <!-- Enrollment Analytics Tab -->
                        <div class="tab-pane fade show active" id="enrollment" role="tabpanel">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Enrollment Trends Over Time</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="enrollmentTrendsChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Students by Programme</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="programmeDistributionChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Academic Performance Tab -->
                        <div class="tab-pane fade" id="performance" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Grade Distribution</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="gradeDistributionChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Programme Performance Comparison</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="programmePerformanceChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Financial Analytics Tab -->
                        <div class="tab-pane fade" id="financial" role="tabpanel">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Fee Collection Trends</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="feeCollectionChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Payment Methods</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="paymentMethodChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Accommodation Tab -->
                        <div class="tab-pane fade" id="hostel" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Hostel Occupancy Rates</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="hostelOccupancyChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Accommodation by Gender</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="accommodationGenderChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Attendance Tab -->
                        <div class="tab-pane fade" id="attendance" role="tabpanel">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Weekly Attendance Trends</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="attendanceTrendsChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Course Attendance Rates</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-container" style="height: 350px; overflow-y: auto;">
                                                <canvas id="courseAttendanceChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chart instances storage
    const charts = {};
    
    // Common chart configuration
    const chartConfig = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            }
        }
    };

    // Initialize all charts
    initializeCharts();
    
    // Load data for all sections
    loadEnrollmentData();
    loadPerformanceData();
    loadFinancialData();
    loadHostelData();
    loadAttendanceData();

    // Tab change event listeners
    document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) {
            const targetId = event.target.getAttribute('data-bs-target').substring(1);
            setTimeout(() => {
                Object.values(charts).forEach(chart => {
                    if (chart) chart.resize();
                });
            }, 100);
        });
    });

    // Refresh data button
    document.getElementById('refreshData').addEventListener('click', function() {
        this.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refreshing...';
        this.disabled = true;
        
        loadEnrollmentData();
        loadPerformanceData();
        loadFinancialData();
        loadHostelData();
        loadAttendanceData();
        
        setTimeout(() => {
            this.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh Data';
            this.disabled = false;
        }, 2000);
    });

    function initializeCharts() {
        // Gender Distribution Chart (Doughnut)
        const genderCtx = document.getElementById('genderDistributionChart').getContext('2d');
        charts.genderChart = new Chart(genderCtx, {
            type: 'doughnut',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [
                        '#FF6384',
                        '#36A2EB',
                        '#FFCE56'
                    ]
                }]
            },
            options: {
                ...chartConfig,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Enrollment Trends Chart (Line)
        const enrollmentTrendsCtx = document.getElementById('enrollmentTrendsChart').getContext('2d');
        charts.enrollmentTrendsChart = new Chart(enrollmentTrendsCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Enrollments',
                    data: [],
                    borderColor: '#36A2EB',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                ...chartConfig,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Programme Distribution Chart (Bar)
        const programmeCtx = document.getElementById('programmeDistributionChart').getContext('2d');
        charts.programmeChart = new Chart(programmeCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Students',
                    data: [],
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                        '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                    ]
                }]
            },
            options: {
                ...chartConfig,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                indexAxis: 'y'
            }
        });

        // Grade Distribution Chart (Bar)
        const gradeCtx = document.getElementById('gradeDistributionChart').getContext('2d');
        charts.gradeChart = new Chart(gradeCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Number of Students',
                    data: [],
                    backgroundColor: '#36A2EB'
                }]
            },
            options: {
                ...chartConfig,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Programme Performance Chart (Radar)
        const performanceCtx = document.getElementById('programmePerformanceChart').getContext('2d');
        charts.performanceChart = new Chart(performanceCtx, {
            type: 'radar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Average GPA',
                    data: [],
                    borderColor: '#FF6384',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    pointBackgroundColor: '#FF6384'
                }]
            },
            options: {
                ...chartConfig,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 4.0
                    }
                }
            }
        });

        // Fee Collection Chart (Line)
        const feeCtx = document.getElementById('feeCollectionChart').getContext('2d');
        charts.feeChart = new Chart(feeCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Fee Collection (KES)',
                    data: [],
                    borderColor: '#4BC0C0',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                ...chartConfig,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'KES ' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        // Payment Method Chart (Pie)
        const paymentCtx = document.getElementById('paymentMethodChart').getContext('2d');
        charts.paymentChart = new Chart(paymentCtx, {
            type: 'pie',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
                    ]
                }]
            },
            options: {
                ...chartConfig,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Hostel Occupancy Chart (Bar)
        const hostelCtx = document.getElementById('hostelOccupancyChart').getContext('2d');
        charts.hostelChart = new Chart(hostelCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Occupancy Rate (%)',
                    data: [],
                    backgroundColor: '#9966FF'
                }]
            },
            options: {
                ...chartConfig,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });

        // Accommodation Gender Chart (Doughnut)
        const accommodationGenderCtx = document.getElementById('accommodationGenderChart').getContext('2d');
        charts.accommodationGenderChart = new Chart(accommodationGenderCtx, {
            type: 'doughnut',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56']
                }]
            },
            options: {
                ...chartConfig,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Attendance Trends Chart (Line)
        const attendanceTrendsCtx = document.getElementById('attendanceTrendsChart').getContext('2d');
        charts.attendanceTrendsChart = new Chart(attendanceTrendsCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Attendance Count',
                    data: [],
                    borderColor: '#FF9F40',
                    backgroundColor: 'rgba(255, 159, 64, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                ...chartConfig,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Course Attendance Chart (Horizontal Bar)
        const courseAttendanceCtx = document.getElementById('courseAttendanceChart').getContext('2d');
        charts.courseAttendanceChart = new Chart(courseAttendanceCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Attendance Rate (%)',
                    data: [],
                    backgroundColor: '#4BC0C0'
                }]
            },
            options: {
                ...chartConfig,
                indexAxis: 'y',
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    function loadEnrollmentData() {
        fetch('/analytics/api/student-enrollment/')
            .then(response => response.json())
            .then(data => {
                // Update gender distribution chart
                const genderLabels = data.gender_distribution.map(item => 
                    item.user__gender ? item.user__gender.charAt(0).toUpperCase() + item.user__gender.slice(1) : 'Not Specified'
                );
                const genderCounts = data.gender_distribution.map(item => item.count);
                
                charts.genderChart.data.labels = genderLabels;
                charts.genderChart.data.datasets[0].data = genderCounts;
                charts.genderChart.update();

                // Update enrollment trends
                charts.enrollmentTrendsChart.data.labels = data.semester_trends.map(item => item.semester);
                charts.enrollmentTrendsChart.data.datasets[0].data = data.semester_trends.map(item => item.enrollments);
                charts.enrollmentTrendsChart.update();

                // Update programme distribution
                const topProgrammes = data.programme_data.slice(0, 8); // Show top 8
                charts.programmeChart.data.labels = topProgrammes.map(item => 
                    item.name.length > 20 ? item.name.substring(0, 20) + '...' : item.name
                );
                charts.programmeChart.data.datasets[0].data = topProgrammes.map(item => item.student_count);
                charts.programmeChart.update();

                // Update enrollment count in metric card
                const totalEnrollments = data.semester_trends.reduce((sum, item) => sum + item.enrollments, 0);
                document.getElementById('enrollmentCount').textContent = totalEnrollments.toLocaleString();
            })
            .catch(error => {
                console.error('Error loading enrollment data:', error);
                document.getElementById('enrollmentCount').textContent = 'Error';
            });
    }

    function loadPerformanceData() {
        fetch('/analytics/api/academic-performance/')
            .then(response => response.json())
            .then(data => {
                // Update grade distribution chart
                charts.gradeChart.data.labels = data.grade_distribution.map(item => item.grade);
                charts.gradeChart.data.datasets[0].data = data.grade_distribution.map(item => item.count);
                charts.gradeChart.update();

                // Update programme performance radar chart
                const validPerformance = data.programme_performance.filter(item => item.avg_gpa !== null);
                charts.performanceChart.data.labels = validPerformance.map(item => 
                    item.name.length > 15 ? item.name.substring(0, 15) + '...' : item.name
                );
                charts.performanceChart.data.datasets[0].data = validPerformance.map(item => 
                    parseFloat(item.avg_gpa).toFixed(2)
                );
                charts.performanceChart.update();

                // Update metric cards
                const avgGPA = validPerformance.length > 0 ? 
                    (validPerformance.reduce((sum, item) => sum + parseFloat(item.avg_gpa), 0) / validPerformance.length).toFixed(2) : '0.00';
                document.getElementById('avgGPA').textContent = avgGPA;
                document.getElementById('completionRate').textContent = data.assignment_completion_rate.toFixed(1) + '%';
            })
            .catch(error => {
                console.error('Error loading performance data:', error);
                document.getElementById('avgGPA').textContent = 'Error';
                document.getElementById('completionRate').textContent = 'Error';
            });
    }

    function loadFinancialData() {
        fetch('/analytics/api/financial-data/')
            .then(response => response.json())
            .then(data => {
                // Update fee collection trends
                charts.feeChart.data.labels = data.monthly_trends.months;
                charts.feeChart.data.datasets[0].data = data.monthly_trends.collections;
                charts.feeChart.update();

                // Update payment method distribution
                charts.paymentChart.data.labels = data.payment_methods.map(item => 
                    item.payment_method.replace('_', ' ').toUpperCase()
                );
                charts.paymentChart.data.datasets[0].data = data.payment_methods.map(item => item.count);
                charts.paymentChart.update();
            })
            .catch(error => {
                console.error('Error loading financial data:', error);
            });
    }

    function loadHostelData() {
        fetch('/analytics/api/hostel-occupancy/')
            .then(response => response.json())
            .then(data => {
                // Update hostel occupancy chart
                charts.hostelChart.data.labels = data.hostel_occupancy.map(item => item.hostel_name);
                charts.hostelChart.data.datasets[0].data = data.hostel_occupancy.map(item => item.occupancy_rate);
                charts.hostelChart.update();

                // Update accommodation gender distribution
                charts.accommodationGenderChart.data.labels = data.gender_accommodation.map(item => 
                    item.student__user__gender ? item.student__user__gender.charAt(0).toUpperCase() + item.student__user__gender.slice(1) : 'Not Specified'
                );
                charts.accommodationGenderChart.data.datasets[0].data = data.gender_accommodation.map(item => item.count);
                charts.accommodationGenderChart.update();

                // Update overall occupancy rate
                const avgOccupancy = data.hostel_occupancy.length > 0 ? 
                    (data.hostel_occupancy.reduce((sum, item) => sum + item.occupancy_rate, 0) / data.hostel_occupancy.length).toFixed(0) : 0;
                document.getElementById('occupancyRate').textContent = avgOccupancy + '%';
            })
            .catch(error => {
                console.error('Error loading hostel data:', error);
                document.getElementById('occupancyRate').textContent = 'Error';
            });
    }

    function loadAttendanceData() {
        fetch('/analytics/api/attendance-analytics/')
            .then(response => response.json())
            .then(data => {
                // Update weekly attendance trends
                charts.attendanceTrendsChart.data.labels = data.weekly_trends.map(item => `Week ${item.week}`);
                charts.attendanceTrendsChart.data.datasets[0].data = data.weekly_trends.map(item => item.attendance);
                charts.attendanceTrendsChart.update();

                // Update course attendance rates (show top 10)
                const topCourses = data.course_attendance.slice(0, 10);
                charts.courseAttendanceChart.data.labels = topCourses.map(item => item.course_code);
                charts.courseAttendanceChart.data.datasets[0].data = topCourses.map(item => item.attendance_rate);
                charts.courseAttendanceChart.update();
            })
            .catch(error => {
                console.error('Error loading attendance data:', error);
            });
    }

    // Load library usage for metric card
    fetch('/analytics/api/library-usage/')
        .then(response => response.json())
        .then(data => {
            const totalTransactions = data.daily_usage.reduce((sum, item) => sum + item.transactions, 0);
            document.getElementById('libraryUsage').textContent = totalTransactions.toLocaleString();
        })
        .catch(error => {
            console.error('Error loading library data:', error);
            document.getElementById('libraryUsage').textContent = 'Error';
        });
});
</script>

<style>
@media print {
    .btn, .nav-tabs, .card-footer {
        display: none !important;
    }
    
    .onprintContainer {
        margin: 0 !important;
        padding: 0 !important;
    }
    
    .card {
        border: none !important;
        box-shadow: none !important;
    }
    
    .chart-container {
        height: 200px !important;
    }
}

.card:hover {
    transform: translateY(-2px);
    transition: transform 0.2s ease;
}

.chart-container {
    position: relative;
}

.metric-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
}

.bg-primary { background: linear-gradient(135deg, #007bff, #0056b3) !important; }
.bg-success { background: linear-gradient(135deg, #28a745, #1e7e34) !important; }
.bg-info { background: linear-gradient(135deg, #17a2b8, #117a8b) !important; }
.bg-warning { background: linear-gradient(135deg, #ffc107, #e0a800) !important; }

.border-end {
    border-right: 1px solid #dee2e6;
}

.alert-message {
    position: relative;
    padding: 0.75rem 1.25rem;
    margin-bottom: 1rem;
    border: 1px solid transparent;
    border-radius: 0.25rem;
}

.alert-success {
    color: #155724;
    background-color: #d4edda;
    border-color: #c3e6cb;
}

.alert-danger {
    color: #721c24;
    background-color: #f8d7da;
    border-color: #f5c6cb;
}

.alert-warning {
    color: #856404;
    background-color: #fff3cd;
    border-color: #ffeaa7;
}

.close-message {
    position: absolute;
    top: 0;
    right: 0;
    padding: 0.75rem 1.25rem;
    color: inherit;
    cursor: pointer;
}

.close-message:hover {
    opacity: 0.75;
}
</style>

{% endblock %}