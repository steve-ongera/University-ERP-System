{% extends 'cod_base.html' %}
{% load static %}

{% block content %}

<!-- System Messages -->
<div class="message-container" id="system-messages">
    {% for message in messages %}
    <div class="alert-message alert-{{ message.tags }}">
        {{ message }}
        <span class="close-message">&times;</span>
    </div>
    {% endfor %}
</div>

<div class="container onprintContainer">
    <!-- Header Section -->
    <div class="row p-3">
        <div class="row d-flex flex-row align-items-center">
            <div class="col-md-8">
                <h2 class="fw-bold card-stitle mb-2">Student Details</h2>
                <p class="text-muted mb-0">{{ department.name }}</p>
            </div>
            <div class="col-md-4">
                <div class="btn-group float-end" role="group">
                    <a href="{% url 'cod_students_list' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back
                    </a>
                    <button class="btn btn-outline-success" onclick="window.print()">
                        <i class="bi bi-printer"></i> Print
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row p-3">
        <!-- Profile Card -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-person-badge"></i> Student Profile
                    </h5>
                </div>
                <div class="card-body text-center">
                    <div class="profile-picture-container mb-3">
                        {% if student.user.profile_picture %}
                        <img src="{{ student.user.profile_picture.url }}" 
                             class="profile-picture img-thumbnail rounded-circle" 
                             alt="Profile Picture"
                             style="width: 150px; height: 150px; object-fit: cover;">
                        {% else %}
                        <div class="profile-picture-placeholder rounded-circle d-flex align-items-center justify-content-center mx-auto"
                             style="width: 150px; height: 150px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <div class="text-white fw-bold" style="font-size: 2.5rem;">
                                {{ student.user.first_name|first|upper }}{{ student.user.last_name|first|upper }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <h4 class="mb-2">{{ student.user.get_full_name }}</h4>
                    <p class="text-muted mb-1">{{ student.student_id }}</p>
                    <p class="text-muted small mb-3">{{ student.user.email|default:"No email" }}</p>
                    
                    <div class="student-status mb-3">
                        <span class="badge status-badge 
                            {% if student.status == 'active' %}bg-success
                            {% elif student.status == 'suspended' %}bg-warning text-dark
                            {% elif student.status == 'deferred' %}bg-info
                            {% elif student.status == 'graduated' %}bg-primary
                            {% else %}bg-danger{% endif %}">
                            {{ student.get_status_display }}
                        </span>
                    </div>
                    
                    <hr class="my-3">
                    
                    <!-- Quick Stats -->
                    <div class="row mb-3">
                        <div class="col-4">
                            <div class="stat-card text-center p-2 bg-light rounded">
                                <div class="stat-value text-primary fw-bold" style="font-size: 1.5rem;">{{ cgpa|floatformat:2|default:"0.00" }}</div>
                                <div class="stat-label small text-muted">CGPA</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-card text-center p-2 bg-light rounded">
                                <div class="stat-value text-success fw-bold" style="font-size: 1.5rem;">{{ total_credits_completed|default:0 }}</div>
                                <div class="stat-label small text-muted">Credits</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-card text-center p-2 bg-light rounded">
                                <div class="stat-value text-warning fw-bold" style="font-size: 1.5rem;">{{ attendance_percentage|floatformat:1 }}%</div>
                                <div class="stat-label small text-muted">Attendance</div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-3">
                    
                    <!-- Quick Info -->
                    <div class="quick-info text-start">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted"><i class="bi bi-mortarboard"></i> Programme:</span>
                            <span class="fw-bold">{{ student.programme.code }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted"><i class="bi bi-calendar"></i> Year/Sem:</span>
                            <span class="fw-bold">Y{{ student.current_year }}/S{{ student.current_semester }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted"><i class="bi bi-building"></i> Department:</span>
                            <span class="fw-bold">{{ student.programme.department.code }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted"><i class="bi bi-calendar-check"></i> Admitted:</span>
                            <span class="fw-bold">{{ student.admission_date|date:"M Y" }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabbed Content -->
        <div class="col-md-8 mb-4">
            <div class="card shadow-sm">
                <!-- Tab Navigation -->
                <div class="card-header bg-white border-bottom-0 p-0">
                    <ul class="nav nav-tabs card-header-tabs" id="studentTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="personal-tab" data-bs-toggle="tab" 
                                    data-bs-target="#personal" type="button" role="tab">
                                <i class="bi bi-person"></i> Personal Info
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="academic-tab" data-bs-toggle="tab" 
                                    data-bs-target="#academic" type="button" role="tab">
                                <i class="bi bi-book"></i> Academic
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="enrollments-tab" data-bs-toggle="tab" 
                                    data-bs-target="#enrollments" type="button" role="tab">
                                <i class="bi bi-list-check"></i> Enrollments
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="performance-tab" data-bs-toggle="tab" 
                                    data-bs-target="#performance" type="button" role="tab">
                                <i class="bi bi-graph-up"></i> Performance
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" 
                                    data-bs-target="#attendance" type="button" role="tab">
                                <i class="bi bi-calendar-check"></i> Attendance
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- Tab Content -->
                <div class="card-body">
                    <div class="tab-content" id="studentTabsContent">
                        <!-- Personal Information Tab -->
                        <div class="tab-pane fade show active" id="personal" role="tabpanel">
                            <h5 class="mb-3 fw-bold text-primary">
                                <i class="bi bi-person-vcard"></i> Personal Information
                            </h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Full Name</label>
                                    <p class="fw-semibold">{{ student.user.get_full_name }}</p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Username</label>
                                    <p class="fw-semibold">{{ student.user.username }}</p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Email Address</label>
                                    <p class="fw-semibold">{{ student.user.email|default:"Not provided" }}</p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Phone Number</label>
                                    <p class="fw-semibold">{{ student.user.phone|default:"Not provided" }}</p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Gender</label>
                                    <p class="fw-semibold">{{ student.user.get_gender_display|default:"Not specified" }}</p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Date of Birth</label>
                                    <p class="fw-semibold">{{ student.user.date_of_birth|date:"M d, Y"|default:"Not provided" }}</p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Blood Group</label>
                                    <p class="fw-semibold">{{ student.blood_group|default:"Not provided" }}</p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Nationality</label>
                                    <p class="fw-semibold">{{ student.nationality|default:"Not provided" }}</p>
                                </div>
                                <div class="col-12 mb-3">
                                    <label class="small text-muted">Address</label>
                                    <p class="fw-semibold">{{ student.user.address|default:"Not provided" }}</p>
                                </div>
                            </div>

                            <hr class="my-4">

                            <h5 class="mb-3 fw-bold text-primary">
                                <i class="bi bi-people"></i> Guardian Information
                            </h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Guardian Name</label>
                                    <p class="fw-semibold">{{ student.guardian_name|default:"Not provided" }}</p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Guardian Phone</label>
                                    <p class="fw-semibold">{{ student.guardian_phone|default:"Not provided" }}</p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Relationship</label>
                                    <p class="fw-semibold">{{ student.guardian_relationship|default:"Not provided" }}</p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Emergency Contact</label>
                                    <p class="fw-semibold">{{ student.emergency_contact|default:"Not provided" }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Academic Information Tab -->
                        <div class="tab-pane fade" id="academic" role="tabpanel">
                            <h5 class="mb-3 fw-bold text-primary">
                                <i class="bi bi-mortarboard"></i> Academic Details
                            </h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Programme</label>
                                    <p class="fw-semibold">{{ student.programme.name }}</p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Programme Code</label>
                                    <p class="fw-semibold">{{ student.programme.code }}</p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Department</label>
                                    <p class="fw-semibold">{{ student.programme.department.name }}</p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Faculty</label>
                                    <p class="fw-semibold">{{ student.programme.faculty.name|default:"N/A" }}</p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Programme Type</label>
                                    <p class="fw-semibold">{{ student.programme.get_programme_type_display }}</p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Duration</label>
                                    <p class="fw-semibold">{{ student.programme.duration_years }} Years</p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Current Year</label>
                                    <p class="fw-semibold">Year {{ student.current_year }}</p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Current Semester</label>
                                    <p class="fw-semibold">Semester {{ student.current_semester }}</p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Admission Date</label>
                                    <p class="fw-semibold">{{ student.admission_date|date:"F d, Y" }}</p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Admission Type</label>
                                    <p class="fw-semibold">{{ student.get_admission_type_display }}</p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Sponsor Type</label>
                                    <p class="fw-semibold">{{ student.get_sponsor_type_display|default:"Self" }}</p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="small text-muted">Student Status</label>
                                    <p>
                                        <span class="badge 
                                            {% if student.status == 'active' %}bg-success
                                            {% elif student.status == 'suspended' %}bg-warning text-dark
                                            {% else %}bg-danger{% endif %}">
                                            {{ student.get_status_display }}
                                        </span>
                                    </p>
                                </div>
                            </div>

                            <hr class="my-4">

                            <h5 class="mb-3 fw-bold text-primary">
                                <i class="bi bi-bar-chart"></i> Academic Statistics
                            </h5>
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <div class="stat-card text-center p-3 bg-light rounded">
                                        <div class="stat-value text-primary" style="font-size: 2rem;">{{ cgpa|floatformat:2|default:"0.00" }}</div>
                                        <div class="stat-label small text-muted">CGPA</div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="stat-card text-center p-3 bg-light rounded">
                                        <div class="stat-value text-success" style="font-size: 2rem;">{{ total_credits_completed|default:0 }}</div>
                                        <div class="stat-label small text-muted">Credits Earned</div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="stat-card text-center p-3 bg-light rounded">
                                        <div class="stat-value text-info" style="font-size: 2rem;">{{ academic_stats.total_courses|default:0 }}</div>
                                        <div class="stat-label small text-muted">Courses Taken</div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="stat-card text-center p-3 bg-light rounded">
                                        <div class="stat-value text-warning" style="font-size: 2rem;">{{ attendance_percentage|floatformat:1 }}%</div>
                                        <div class="stat-label small text-muted">Attendance</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Enrollments Tab -->
                        <div class="tab-pane fade" id="enrollments" role="tabpanel">
                            <h5 class="mb-3 fw-bold text-primary">
                                <i class="bi bi-list-check"></i> Course Enrollments
                            </h5>
                            
                            <!-- Sub-tabs for academic years -->
                            <ul class="nav nav-pills mb-3" id="enrollmentYearTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="current-enrollments-tab" 
                                            data-bs-toggle="pill" data-bs-target="#current-enrollments" 
                                            type="button" role="tab">
                                        Current Courses ({{ active_enrollments }})
                                    </button>
                                </li>
                                {% for year, semesters in enrollments_by_period.items %}
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="year-{{ year|slugify }}-tab" 
                                            data-bs-toggle="pill" data-bs-target="#year-{{ year|slugify }}" 
                                            type="button" role="tab">
                                        {{ year }}
                                    </button>
                                </li>
                                {% endfor %}
                            </ul>

                            <div class="tab-content" id="enrollmentYearTabsContent">
                                <!-- Current Enrollments -->
                                <div class="tab-pane fade show active" id="current-enrollments" role="tabpanel">
                                    {% if current_enrollments %}
                                    <div class="table-responsive">
                                        <table class="table table-hover table-sm">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Course Code</th>
                                                    <th>Course Name</th>
                                                    <th>Credits</th>
                                                    <th>Lecturer</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for enrollment in current_enrollments %}
                                                <tr>
                                                    <td class="fw-semibold">{{ enrollment.course.code }}</td>
                                                    <td>{{ enrollment.course.name }}</td>
                                                    <td><span class="badge bg-info">{{ enrollment.course.credit_hours }}</span></td>
                                                    <td>{{ enrollment.lecturer.user.get_full_name|default:"TBA" }}</td>
                                                    <td>
                                                        <span class="badge bg-success">
                                                            <i class="bi bi-check-circle"></i> Active
                                                        </span>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <div class="alert alert-info">No current enrollments</div>
                                    {% endif %}
                                </div>

                                <!-- Academic Year Enrollments -->
                                {% for year, semesters in enrollments_by_period.items %}
                                <div class="tab-pane fade" id="year-{{ year|slugify }}" role="tabpanel">
                                    <!-- Semester sub-tabs -->
                                    <ul class="nav nav-pills nav-fill mb-3 bg-light p-2 rounded" role="tablist">
                                        {% for semester_num, data in semesters.items %}
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link {% if forloop.first %}active{% endif %}" 
                                                    id="semester-{{ year|slugify }}-{{ semester_num }}-tab" 
                                                    data-bs-toggle="pill" 
                                                    data-bs-target="#semester-{{ year|slugify }}-{{ semester_num }}" 
                                                    type="button" role="tab">
                                                Semester {{ semester_num }}
                                            </button>
                                        </li>
                                        {% endfor %}
                                    </ul>

                                    <div class="tab-content">
                                        {% for semester_num, data in semesters.items %}
                                        <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
                                             id="semester-{{ year|slugify }}-{{ semester_num }}" role="tabpanel">
                                            
                                            <!-- Semester Summary -->
                                            <div class="row mb-3">
                                                <div class="col-md-3">
                                                    <div class="text-center p-2 bg-light rounded">
                                                        <div class="fw-bold text-primary">{{ data.enrollments|length }}</div>
                                                        <small class="text-muted">Courses</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="text-center p-2 bg-light rounded">
                                                        <div class="fw-bold text-success">
                                                            {% with key=year|add:"|"|add:semester_num|stringformat:"s" %}
                                                            {{ semester_performance|get_item:key.credits_earned|default:0 }}
                                                            {% endwith %}
                                                        </div>
                                                        <small class="text-muted">Credits Earned</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="text-center p-2 bg-light rounded">
                                                        <div class="fw-bold text-info">
                                                            {% for key, perf in semester_performance.items %}
                                                                {% if perf.year == year and perf.semester == semester_num %}
                                                                    {{ perf.gpa|floatformat:2|default:"N/A" }}
                                                                {% endif %}
                                                            {% endfor %}
                                                        </div>
                                                        <small class="text-muted">Semester GPA</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="text-center p-2 bg-light rounded">
                                                        <div class="fw-bold text-warning">
                                                            {% for key, perf in semester_performance.items %}
                                                                {% if perf.year == year and perf.semester == semester_num %}
                                                                    {{ perf.avg_marks|floatformat:1|default:"N/A" }}%
                                                                {% endif %}
                                                            {% endfor %}
                                                        </div>
                                                        <small class="text-muted">Avg Marks</small>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Courses Table -->
                                            <div class="table-responsive">
                                                <table class="table table-hover table-sm">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Course Code</th>
                                                            <th>Course Name</th>
                                                            <th>Credits</th>
                                                            <th>Grade</th>
                                                            <th>Marks</th>
                                                            <th>Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for enrollment in data.enrollments %}
                                                        <tr>
                                                            <td class="fw-semibold">{{ enrollment.course.code }}</td>
                                                            <td>{{ enrollment.course.name }}</td>
                                                            <td><span class="badge bg-info">{{ enrollment.course.credit_hours }}</span></td>
                                                            <td>
                                                                {% if enrollment.grade %}
                                                                <span class="badge 
                                                                    {% if enrollment.grade.grade == 'A+' or enrollment.grade.grade == 'A' %}bg-success
                                                                    {% elif enrollment.grade.grade == 'B+' or enrollment.grade.grade == 'B' %}bg-primary
                                                                    {% elif enrollment.grade.grade == 'C+' or enrollment.grade.grade == 'C' %}bg-info
                                                                    {% elif enrollment.grade.grade == 'D+' or enrollment.grade.grade == 'D' %}bg-warning
                                                                    {% else %}bg-danger{% endif %}">
                                                                    {{ enrollment.grade.grade }}
                                                                </span>
                                                                {% else %}
                                                                <span class="badge bg-secondary">Pending</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if enrollment.grade %}
                                                                {{ enrollment.grade.total_marks|floatformat:1 }}%
                                                                {% else %}
                                                                -
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if enrollment.grade.is_passed %}
                                                                <span class="badge bg-success">
                                                                    <i class="bi bi-check-circle"></i> Passed
                                                                </span>
                                                                {% elif enrollment.grade %}
                                                                <span class="badge bg-danger">
                                                                    <i class="bi bi-x-circle"></i> Failed
                                                                </span>
                                                                {% else %}
                                                                <span class="badge bg-secondary">In Progress</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Performance Tab -->
                        <div class="tab-pane fade" id="performance" role="tabpanel">
                            <h5 class="mb-3 fw-bold text-primary">
                                <i class="bi bi-graph-up"></i> Academic Performance
                            </h5>
                            
                            <!-- Overall Performance Summary -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card border-primary">
                                        <div class="card-body text-center">
                                            <h3 class="text-primary mb-0">{{ cgpa|floatformat:2 }}</h3>
                                            <small class="text-muted">Cumulative GPA</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-success">
                                        <div class="card-body text-center">
                                            <h3 class="text-success mb-0">{{ total_credits_completed }}</h3>
                                            <small class="text-muted">Credits Earned</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-info">
                                        <div class="card-body text-center">
                                            <h3 class="text-info mb-0">{{ academic_stats.avg_total|floatformat:1 }}%</h3>
                                            <small class="text-muted">Avg Marks</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-warning">
                                        <div class="card-body text-center">
                                            <h3 class="text-warning mb-0">{{ academic_stats.total_courses }}</h3>
                                            <small class="text-muted">Courses Completed</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Grade Distribution -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h6 class="fw-bold mb-3">Grade Distribution</h6>
                                    <div class="d-flex flex-wrap gap-3">
                                        {% for grade, count in grade_distribution.items %}
                                        <div class="grade-item p-3 bg-light rounded text-center" style="min-width: 100px;">
                                            <span class="grade-badge badge 
                                                {% if grade == 'A+' or grade == 'A' %}bg-success
                                                {% elif grade == 'B+' or grade == 'B' %}bg-primary
                                                {% elif grade == 'C+' or grade == 'C' %}bg-info
                                                {% elif grade == 'D+' or grade == 'D' %}bg-warning text-dark
                                                {% else %}bg-danger{% endif %}" 
                                                style="font-size: 1.5rem; padding: 0.5rem 1rem;">
                                                {{ grade }}
                                            </span>
                                            <div class="mt-2">
                                                <div class="fw-bold">{{ count }}</div>
                                                <small class="text-muted">course{{ count|pluralize }}</small>
                                            </div>
                                        </div>
                                        {% empty %}
                                        <p class="text-muted">No grades recorded yet</p>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <!-- Performance Over Time Chart -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h6 class="fw-bold mb-3">Performance Trend</h6>
                                    <canvas id="performanceChart" height="100"></canvas>
                                </div>
                            </div>

                            <!-- Semester-wise Performance Table -->
                            <div class="row">
                                <div class="col-12">
                                    <h6 class="fw-bold mb-3">Semester-wise Performance</h6>
                                    <div class="table-responsive">
                                        <table class="table table-hover table-sm">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Academic Period</th>
                                                    <th>Courses</th>
                                                    <th>Credits Earned</th>
                                                    <th>GPA</th>
                                                    <th>Avg Marks</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for key, perf in semester_performance.items %}
                                                <tr>
                                                    <td class="fw-semibold">{{ perf.display }}</td>
                                                    <td>{{ perf.completed_courses }}/{{ perf.total_courses }}</td>
                                                    <td><span class="badge bg-success">{{ perf.credits_earned }}</span></td>
                                                    <td>
                                                        <span class="badge 
                                                            {% if perf.gpa >= 3.5 %}bg-success
                                                            {% elif perf.gpa >= 3.0 %}bg-primary
                                                            {% elif perf.gpa >= 2.5 %}bg-info
                                                            {% elif perf.gpa >= 2.0 %}bg-warning
                                                            {% else %}bg-danger{% endif %}">
                                                            {{ perf.gpa|floatformat:2 }}
                                                        </span>
                                                    </td>
                                                    <td>{{ perf.avg_marks|floatformat:1 }}%</td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="5" class="text-center text-muted">No performance data available</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Attendance Tab -->
                        <div class="tab-pane fade" id="attendance" role="tabpanel">
                            <h5 class="mb-3 fw-bold text-primary">
                                <i class="bi bi-calendar-check"></i> Attendance Records
                            </h5>
                            
                            <!-- Overall Attendance Stats -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card border-success">
                                        <div class="card-body text-center">
                                            <h3 class="text-success mb-0">{{ present_count }}</h3>
                                            <small class="text-muted">Present</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-danger">
                                        <div class="card-body text-center">
                                            <h3 class="text-danger mb-0">{{ absent_count }}</h3>
                                            <small class="text-muted">Absent</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-warning">
                                        <div class="card-body text-center">
                                            <h3 class="text-warning mb-0">{{ late_count }}</h3>
                                            <small class="text-muted">Late</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-primary">
                                        <div class="card-body text-center">
                                            <h3 class="text-primary mb-0">{{ attendance_percentage|floatformat:1 }}%</h3>
                                            <small class="text-muted">Percentage</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Attendance by Semester -->
                            <ul class="nav nav-pills mb-3" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="all-attendance-tab" 
                                            data-bs-toggle="pill" data-bs-target="#all-attendance" 
                                            type="button" role="tab">
                                        All Records
                                    </button>
                                </li>
                                {% for key, data in attendance_by_semester.items %}
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="attendance-{{ key|slugify }}-tab" 
                                            data-bs-toggle="pill" data-bs-target="#attendance-{{ key|slugify }}" 
                                            type="button" role="tab">
                                        {{ data.year }} - S{{ data.semester }}
                                    </button>
                                </li>
                                {% endfor %}
                            </ul>

                            <div class="tab-content">
                                <!-- All Attendance Records -->
                                <div class="tab-pane fade show active" id="all-attendance" role="tabpanel">
                                    {% if attendance_records %}
                                    <div class="table-responsive">
                                        <table class="table table-hover table-sm">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Course</th>
                                                    <th>Week</th>
                                                    <th>Status</th>
                                                    <th>Remarks</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for record in attendance_records %}
                                                <tr>
                                                    <td>{{ record.attendance_session.session_date|date:"M d, Y" }}</td>
                                                    <td>{{ record.timetable_slot.course.code }}</td>
                                                    <td><span class="badge bg-secondary">Week {{ record.week_number }}</span></td>
                                                    <td>
                                                        {% if record.status == 'present' %}
                                                        <span class="badge bg-success">
                                                            <i class="bi bi-check-circle"></i> Present
                                                        </span>
                                                        {% elif record.status == 'absent' %}
                                                        <span class="badge bg-danger">
                                                            <i class="bi bi-x-circle"></i> Absent
                                                        </span>
                                                        {% elif record.status == 'late' %}
                                                        <span class="badge bg-warning">
                                                            <i class="bi bi-clock"></i> Late
                                                        </span>
                                                        {% else %}
                                                        <span class="badge bg-secondary">{{ record.status }}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>{{ record.remarks|default:"-" }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <div class="alert alert-info">No attendance records available</div>
                                    {% endif %}
                                </div>

                                <!-- Semester-specific Attendance -->
                                {% for key, data in attendance_by_semester.items %}
                                <div class="tab-pane fade" id="attendance-{{ key|slugify }}" role="tabpanel">
                                    <!-- Semester Attendance Summary -->
                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <div class="text-center p-2 bg-light rounded">
                                                <div class="fw-bold text-primary">{{ data.total }}</div>
                                                <small class="text-muted">Total Sessions</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center p-2 bg-light rounded">
                                                <div class="fw-bold text-success">{{ data.present }}</div>
                                                <small class="text-muted">Present</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center p-2 bg-light rounded">
                                                <div class="fw-bold text-danger">{{ data.absent }}</div>
                                                <small class="text-muted">Absent</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center p-2 bg-light rounded">
                                                <div class="fw-bold text-warning">{{ data.percentage|floatformat:1 }}%</div>
                                                <small class="text-muted">Attendance</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Records Table -->
                                    <div class="table-responsive">
                                        <table class="table table-hover table-sm">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Course</th>
                                                    <th>Week</th>
                                                    <th>Status</th>
                                                    <th>Remarks</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for record in data.records %}
                                                <tr>
                                                    <td>{{ record.attendance_session.session_date|date:"M d, Y" }}</td>
                                                    <td>{{ record.timetable_slot.course.code }}</td>
                                                    <td><span class="badge bg-secondary">Week {{ record.week_number }}</span></td>
                                                    <td>
                                                        {% if record.status == 'present' %}
                                                        <span class="badge bg-success">
                                                            <i class="bi bi-check-circle"></i> Present
                                                        </span>
                                                        {% elif record.status == 'absent' %}
                                                        <span class="badge bg-danger">
                                                            <i class="bi bi-x-circle"></i> Absent
                                                        </span>
                                                        {% elif record.status == 'late' %}
                                                        <span class="badge bg-warning">
                                                            <i class="bi bi-clock"></i> Late
                                                        </span>
                                                        {% else %}
                                                        <span class="badge bg-secondary">{{ record.status }}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>{{ record.remarks|default:"-" }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Performance Chart
    const ctx = document.getElementById('performanceChart');
    if (ctx) {
        const chartData = {
            labels: {{ performance_chart_data.labels|safe }},
            datasets: [
                {
                    label: 'GPA',
                    data: {{ performance_chart_data.gpa_data|safe }},
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.4,
                    yAxisID: 'y'
                },
                {
                    label: 'Average Marks (%)',
                    data: {{ performance_chart_data.avg_marks_data|safe }},
                    borderColor: 'rgb(255, 159, 64)',
                    backgroundColor: 'rgba(255, 159, 64, 0.2)',
                    tension: 0.4,
                    yAxisID: 'y1'
                }
            ]
        };

        new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Academic Performance Over Time'
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        min: 0,
                        max: 4,
                        title: {
                            display: true,
                            text: 'GPA'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        min: 0,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Average Marks (%)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        }
                    }
                }
            }
        });
    }

    // Close message functionality
    document.querySelectorAll('.close-message').forEach(function(button) {
        button.addEventListener('click', function() {
            this.parentElement.style.display = 'none';
        });
    });
});
</script>

<style>
.profile-picture {
    width: 150px;
    height: 150px;
    object-fit: cover;
}

.grade-item {
    transition: transform 0.2s;
}

.grade-item:hover {
    transform: translateY(-5px);
}

.stat-card {
    transition: all 0.3s ease;
}

.stat-card:hover {
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.nav-pills .nav-link {
    color: #495057;
}

.nav-pills .nav-link.active {
    background-color: #0d6efd;
}

@media print {
    .btn-group, .nav-tabs, .nav-pills {
        display: none !important;
    }
}
</style>

{% endblock %}