{% extends 'admin_base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}


{% block content %}

<style>
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
    .small-chart {
        height: 200px !important;
    }
    .loading-chart {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 300px;
        color: #6c757d;
    }
</style>

<div class="container onprintContainer">
    <!-- Header -->
    <div class="row mt-3 d-flex flex-row pb-3">
        <div class="col-md-12 d-flex justify-content-between">
            <h3 class="primary-text">Admin Profile & System Analytics</h3>
            <div>
                <button class="btn primary-outline-btn btn-sm" id="refreshData">
                    <i class="ri-refresh-line"></i> Refresh
                </button>
                <button class="btn primary-btn btn-sm" id="exportReport">
                    <i class="ri-download-line"></i> Export Report
                </button>
            </div>
        </div>
    </div>

    <div class="row bg-white shadow">
        <!-- Left Side - Navigation -->
        <div class="col-md-3">
            <div class="card col-md-12">
                <div class="card-body text-md-left ml-0">
                    <div class="nav flex-column nav-tabs prof" id="v-tabs-tab" role="tablist" aria-orientation="vertical">
                        <!-- Admin Profile Section -->
                        <div class="mb-4 d-flex align-items-center flex-column">
                            <div class="profile-pic mb-3 position-relative">
                                {% if current_user.profile_picture %}
                                    <img src="{{ current_user.profile_picture.url }}" id="profilePicture" class="img-fluid rounded-circle" alt="Admin Profile" />
                                {% else %}
                                    <img src="{% static 'avatar2.png' %}" id="profilePicture" class="img-fluid rounded-circle" alt="Default Profile" />
                                {% endif %}
                                <span class="position-absolute bottom-0 start-100 translate-middle badge border border-blue rounded-circle bg-success">
                                    <i class="ri-shield-check-line text-white"></i>
                                </span>
                            </div>
                            <div class="sticky-top mb-2">
                                <div>
                                    <h6 class="mb-2">{{ current_user.get_full_name }}</h6>
                                    <p class="text-muted small">{{ current_user.user_type|title }} User</p>
                                    <p class="text-muted small">
                                        <i class="ri-time-line"></i> Last Login: {{ current_user.last_login|date:"M d, H:i" }}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation Menu -->
                        <ul class="nav flex-column prof">
                            <li class="nav-item" role="presentation">
                                <a class="nav-link active px-1" href="#system-overview" id="system-overview-tab" data-bs-toggle="tab" role="tab">
                                    <i class="bi bi-speedometer2 mx-3"></i><span>System Overview</span>
                                </a>
                            </li>
                            <li class="nav-item" role="presentation">
                                <a class="nav-link px-0" href="#online-users" id="online-users-tab" data-bs-toggle="tab" role="tab">
                                    <i class="bi bi-people-fill mx-3"></i><span>Online Users</span>
                                    <span class="badge bg-success ms-2" id="onlineCountBadge">{{ online_count }}</span>
                                </a>
                            </li>
                            <li class="nav-item" role="presentation">
                                <a class="nav-link px-0" href="#activity-logs" id="activity-logs-tab" data-bs-toggle="tab" role="tab">
                                    <i class="bi bi-activity mx-3"></i><span>Activity Logs</span>
                                </a>
                            </li>
                            <li class="nav-item" role="presentation">
                                <a class="nav-link px-0" href="#page-analytics" id="page-analytics-tab" data-bs-toggle="tab" role="tab">
                                    <i class="bi bi-graph-up mx-3"></i><span>Page Analytics</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Side - Content -->
        <div class="col-md-9 profile">
            <div class="tab-content">
                <!-- System Overview Tab -->
                <div id="system-overview" class="container tab-pane show active" role="tabpanel">
                    <div class="row mt-3">
                        <!-- Key Metrics Cards -->
                        <div class="col-md-3 mb-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h5 class="card-title">{{ online_count }}</h5>
                                            <p class="card-text small">Users Online</p>
                                        </div>
                                        <i class="bi bi-people-fill fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h5 class="card-title">{{ logins_today }}</h5>
                                            <p class="card-text small">Logins Today</p>
                                        </div>
                                        <i class="bi bi-door-open-fill fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h5 class="card-title">{{ new_users_today }}</h5>
                                            <p class="card-text small">New Users Today</p>
                                        </div>
                                        <i class="bi bi-person-plus-fill fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h5 class="card-title">{{ avg_response_time }}ms</h5>
                                            <p class="card-text small">Avg Response Time</p>
                                        </div>
                                        <i class="bi bi-speedometer2 fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">Daily Activity (Last 7 Days)</h6>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <div class="loading-chart" id="dailyActivityLoading">Loading chart...</div>
                                        <canvas id="dailyActivityChart" style="display: none;"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">User Distribution</h6>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <div class="loading-chart" id="userDistributionLoading">Loading chart...</div>
                                        <canvas id="userDistributionChart" style="display: none;"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- System Stats Row -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">System Statistics</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="text-center p-3">
                                                <h4 class="text-primary">{{ total_users }}</h4>
                                                <p class="mb-0">Total Users</p>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center p-3">
                                                <h4 class="text-success">{{ total_students }}</h4>
                                                <p class="mb-0">Students</p>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center p-3">
                                                <h4 class="text-info">{{ total_lecturers }}</h4>
                                                <p class="mb-0">Lecturers</p>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center p-3">
                                                <h4 class="text-warning">{{ total_staff }}</h4>
                                                <p class="mb-0">Staff</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Online Users Tab -->
                <div id="online-users" class="container tab-pane fade" role="tabpanel">
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between">
                                    <h6 class="card-title mb-0">Currently Online Users</h6>
                                    <div>
                                        <span class="badge bg-success">{{ online_students }} Students</span>
                                        <span class="badge bg-info">{{ online_lecturers }} Lecturers</span>
                                        <span class="badge bg-warning">{{ online_staff }} Staff</span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="onlineUsersTable">
                                            <thead>
                                                <tr>
                                                    <th>User</th>
                                                    <th>Type</th>
                                                    <th>Login Time</th>
                                                    <th>Last Activity</th>
                                                    <th>IP Address</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for session in online_users %}
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="avatar-sm me-2">
                                                                {% if session.user.profile_picture %}
                                                                    <img src="{{ session.user.profile_picture.url }}" class="rounded-circle" width="30" height="30">
                                                                {% else %}
                                                                    <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" style="width:30px; height:30px;">
                                                                        <small class="text-white">{{ session.user.first_name.0 }}{{ session.user.last_name.0 }}</small>
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                            <div>
                                                                <strong>{{ session.user.get_full_name }}</strong><br>
                                                                <small class="text-muted">{{ session.user.username }}</small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge 
                                                            {% if session.user.user_type == 'student' %}bg-success
                                                            {% elif session.user.user_type == 'lecturer' %}bg-info
                                                            {% else %}bg-warning{% endif %}">
                                                            {{ session.user.user_type|title }}
                                                        </span>
                                                    </td>
                                                    <td>{{ session.login_time|date:"M d, H:i" }}</td>
                                                    <td>
                                                        <span class="badge bg-success">
                                                            {{ session.last_activity|timesince }} ago
                                                        </span>
                                                    </td>
                                                    <td>{{ session.ip_address }}</td>
                                                    <td>
                                                        <span class="text-success">
                                                            <i class="bi bi-circle-fill"></i> Online
                                                        </span>
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="6" class="text-center">No users currently online</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activity Logs Tab -->
                <div id="activity-logs" class="container tab-pane fade" role="tabpanel">
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">Recent System Activities</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                        <table class="table table-sm">
                                            <thead class="sticky-top bg-light">
                                                <tr>
                                                    <th>User</th>
                                                    <th>Action</th>
                                                    <th>Description</th>
                                                    <th>Time</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for activity in recent_activities %}
                                                <tr>
                                                    <td>{{ activity.user.username }}</td>
                                                    <td>
                                                        <span class="badge 
                                                            {% if activity.action == 'create' %}bg-success
                                                            {% elif activity.action == 'update' %}bg-info
                                                            {% elif activity.action == 'delete' %}bg-danger
                                                            {% elif activity.action == 'login' %}bg-primary
                                                            {% else %}bg-secondary{% endif %}">
                                                            {{ activity.action|title }}
                                                        </span>
                                                    </td>
                                                    <td>{{ activity.description|truncatechars:60 }}</td>
                                                    <td>
                                                        <small>{{ activity.timestamp|timesince }} ago</small>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page Analytics Tab -->
                <div id="page-analytics" class="container tab-pane fade" role="tabpanel">
                    <div class="row mt-3">
                        <!-- Hourly Page Visits -->
                        <div class="col-md-12 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">Page Visits Today (Hourly)</h6>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <div class="loading-chart" id="hourlyVisitsLoading">Loading chart...</div>
                                        <canvas id="hourlyVisitsChart" style="display: none;"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Most Popular Pages -->
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">Most Visited Pages Today</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Page</th>
                                                    <th>View Name</th>
                                                    <th>Visits</th>
                                                    <th>Unique Users</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for page in popular_pages_today %}
                                                <tr>
                                                    <td><strong>{{ page.url }}</strong></td>
                                                    <td><small class="text-muted">{{ page.view_name }}</small></td>
                                                    <td>{{ page.visits }}</td>
                                                    <td>{{ page.unique_users }}</td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="4" class="text-center">No page visits today</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Load Chart.js from CDN with proper fallback -->
 <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Function to load Chart.js with fallback
function loadChartJS() {
    return new Promise((resolve, reject) => {
        // Try primary CDN
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        script.onload = () => {
            console.log('Chart.js loaded successfully from primary CDN');
            resolve();
        };
        script.onerror = () => {
            console.log('Primary CDN failed, trying fallback...');
            // Try fallback CDN
            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'https://cdn.jsdelivr.net/npm/chart.js';
            fallbackScript.onload = () => {
                console.log('Chart.js loaded successfully from fallback CDN');
                resolve();
            };
            fallbackScript.onerror = () => {
                console.error('All CDNs failed to load Chart.js');
                reject(new Error('Failed to load Chart.js'));
            };
            document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(script);
    });
}

// Initialize charts after Chart.js is loaded
async function initializeCharts() {
    try {
        // Wait for Chart.js to load
        await loadChartJS();
        
        // Verify Chart is available
        if (typeof Chart === 'undefined') {
            throw new Error('Chart.js library not available');
        }

        console.log('Chart.js loaded successfully, initializing charts...');

        // Get data from Django template with proper error handling
        let dailyActivitiesData, hourlyData, userDistribution, pageVisitsData;
        
        try {
            dailyActivitiesData = {{ daily_activities_json|safe }};
            hourlyData = {{ hourly_data_json|safe }};
            userDistribution = {{ user_distribution_json|safe }};
            pageVisitsData = {{ page_visits_data_json|safe }};
            
            console.log('Chart data loaded:', {
                dailyActivitiesData: dailyActivitiesData?.length || 0,
                hourlyData: hourlyData?.length || 0,
                userDistribution: userDistribution?.length || 0,
                pageVisitsData: pageVisitsData?.length || 0
            });
        } catch(e) {
            console.error('Error loading chart data:', e);
            showChartError('Failed to load chart data');
            return;
        }

        // 1. Daily Activity Chart
        const dailyCtx = document.getElementById('dailyActivityChart');
        const dailyLoading = document.getElementById('dailyActivityLoading');
        
        if (dailyCtx && dailyActivitiesData && dailyActivitiesData.length > 0) {
            try {
                new Chart(dailyCtx, {
                    type: 'line',
                    data: {
                        labels: dailyActivitiesData.map(d => new Date(d.date).toLocaleDateString()),
                        datasets: [{
                            label: 'Activities',
                            data: dailyActivitiesData.map(d => d.count),
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Daily Activities'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
                dailyLoading.style.display = 'none';
                dailyCtx.style.display = 'block';
                console.log('Daily activity chart created successfully');
            } catch(e) {
                console.error('Error creating daily activity chart:', e);
                dailyLoading.textContent = 'Error loading chart';
            }
        } else {
            dailyLoading.textContent = 'No data available';
        }

        // 2. User Distribution Pie Chart
        const userCtx = document.getElementById('userDistributionChart');
        const userLoading = document.getElementById('userDistributionLoading');
        
        if (userCtx && userDistribution && userDistribution.length > 0) {
            try {
                new Chart(userCtx, {
                    type: 'doughnut',
                    data: {
                        labels: userDistribution.map(d => d.type),
                        datasets: [{
                            data: userDistribution.map(d => d.count),
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(255, 99, 132, 0.8)',
                                'rgba(255, 205, 86, 0.8)',
                                'rgba(75, 192, 192, 0.8)',
                                'rgba(153, 102, 255, 0.8)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'User Type Distribution'
                            },
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
                userLoading.style.display = 'none';
                userCtx.style.display = 'block';
                console.log('User distribution chart created successfully');
            } catch(e) {
                console.error('Error creating user distribution chart:', e);
                userLoading.textContent = 'Error loading chart';
            }
        } else {
            userLoading.textContent = 'No data available';
        }

        // 3. Hourly Visits Chart
        const hourlyCtx = document.getElementById('hourlyVisitsChart');
        const hourlyLoading = document.getElementById('hourlyVisitsLoading');
        
        if (hourlyCtx && hourlyData) {
            try {
                const hourLabels = Array.from({length: 24}, (_, i) => `${i}:00`);
                new Chart(hourlyCtx, {
                    type: 'bar',
                    data: {
                        labels: hourLabels,
                        datasets: [{
                            label: 'Page Visits',
                            data: hourlyData,
                            backgroundColor: 'rgba(153, 102, 255, 0.6)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Hourly Page Visits Today'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
                hourlyLoading.style.display = 'none';
                hourlyCtx.style.display = 'block';
                console.log('Hourly visits chart created successfully');
            } catch(e) {
                console.error('Error creating hourly visits chart:', e);
                hourlyLoading.textContent = 'Error loading chart';
            }
        } else {
            hourlyLoading.textContent = 'No data available';
        }

        console.log('All charts initialized successfully');
        
    } catch (error) {
        console.error('Failed to initialize charts:', error);
        showChartError('Charts could not be loaded. Please check your internet connection.');
    }
}

function showChartError(message) {
    const loadingElements = document.querySelectorAll('[id$="Loading"]');
    loadingElements.forEach(el => {
        el.textContent = message;
        el.style.color = '#dc3545';
    });
}

// Real-time updates and other functionality
function setupEventHandlers() {
    // Real-time updates
    function updateOnlineUsers() {
        fetch('{% url "admin_profile_api" %}?type=online_users')
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                const badge = document.getElementById('onlineCountBadge');
                if (badge) {
                    badge.textContent = data.count;
                }
                console.log('Online users updated:', data.count);
            })
            .catch(error => {
                console.error('Error updating online users:', error);
            });
    }

    // Refresh data button
    const refreshBtn = document.getElementById('refreshData');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            location.reload();
        });
    }

    // Export report button
    const exportBtn = document.getElementById('exportReport');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            alert('Export functionality to be implemented');
        });
    }

    // Auto-refresh online users every 30 seconds
    setInterval(updateOnlineUsers, 30000);

    // Tab switching handler
    const tabLinks = document.querySelectorAll('a[data-bs-toggle="tab"]');
    tabLinks.forEach(link => {
        link.addEventListener('shown.bs.tab', function(e) {
            // Remove active class from all links
            tabLinks.forEach(l => l.classList.remove('active'));
            // Add active class to current link
            e.target.classList.add('active');
        });
    });
}

// Initialize everything when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, starting initialization...');
    
    // Initialize charts
    initializeCharts();
    
    // Setup event handlers
    setupEventHandlers();
    
    console.log('Initialization completed');
});
</script>
{% endblock %}