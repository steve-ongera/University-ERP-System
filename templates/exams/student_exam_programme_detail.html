{% extends 'admin_base.html' %}
{% load static %}

{% block content %}

<div class="message-container" id="system-messages">
                                {% for message in messages %}
                                <div class="alert-message alert-{{ message.tags }}">
                                    {{ message }}
                                    <span class="close-message">&times;</span>
                                </div>
                                {% endfor %}
                            </div>

<div class="container onprintContainer">
    <!-- Programme Header -->
    <div class="row p-3">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h2 class="fw-bold">{{ programme.name }}</h2>
                        <p class="text-muted mb-1">
                            <span class="badge bg-primary">{{ programme.code }}</span> | 
                            <span class="badge bg-info">{{ programme.duration_years }} Years</span> |
                            <span class="badge bg-secondary">{{ programme.semesters_per_year }} Semesters/Year</span>
                        </p>
                        <p class="mb-0">
                            <i class="bi bi-building me-1"></i>{{ programme.faculty.name }} - {{ programme.department.name }}
                        </p>
                        {% if programme.description %}
                        <p class="mt-2 text-muted">{{ programme.description|truncatechars:150 }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="d-inline-block bg-light rounded p-3">
                            <h4 class="mb-1 text-primary">{{ programme.students.count }}</h4>
                            <small class="text-muted">Total Students</small>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="btn-group float-end">
                            <a href="{% url 'student_exam_programmes_list' %}" class="btn btn-outline-primary">
                                <i class="bi bi-arrow-left"></i> Back to Programmes
                            </a>
                            <button class="btn btn-outline-info" onclick="window.print()">
                                <i class="bi bi-printer"></i> Print
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Academic Years Tabs -->
    <div class="row p-3">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="academicYearTabs" role="tablist">
                        {% for academic_year in academic_years %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link {% if forloop.first %}active{% endif %}" 
                                    id="year-{{ academic_year.id }}-tab" 
                                    data-bs-toggle="tab" 
                                    data-bs-target="#year-{{ academic_year.id }}" 
                                    data-academic-year-id="{{ academic_year.id }}"
                                    type="button" role="tab">
                                <i class="bi bi-calendar me-1"></i>{{ academic_year.year }}
                            </button>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="academicYearTabsContent">
                        {% for academic_year in academic_years %}
                        <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
                             id="year-{{ academic_year.id }}" 
                             role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="fw-bold">Academic Year {{ academic_year.year }}</h5>
                                <div id="loading-{{ academic_year.id }}" class="d-none">
                                    <span class="spinner-border spinner-border-sm me-2"></span>Loading...
                                </div>
                            </div>
                            
                            <!-- Programme Years Sub-tabs -->
                            <ul class="nav nav-pills mb-3" id="programmeYearTabs-{{ academic_year.id }}" role="tablist">
                                {% for year in programme_years %}
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link {% if forloop.first %}active{% endif %}" 
                                            id="prog-year-{{ academic_year.id }}-{{ year }}-tab" 
                                            data-bs-toggle="pill" 
                                            data-bs-target="#prog-year-{{ academic_year.id }}-{{ year }}" 
                                            data-year="{{ year }}"
                                            type="button" role="tab">
                                        Year {{ year }}
                                    </button>
                                </li>
                                {% endfor %}
                            </ul>
                            
                            <div class="tab-content" id="programmeYearTabsContent-{{ academic_year.id }}">
                                {% for year in programme_years %}
                                <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
                                     id="prog-year-{{ academic_year.id }}-{{ year }}" 
                                     role="tabpanel">
                                    
                                    <!-- Semester Sub-tabs -->
                                    <ul class="nav nav-pills nav-sm mb-3" id="semesterTabs-{{ academic_year.id }}-{{ year }}" role="tablist">
                                        {% for semester in programme_semesters %}
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link {% if forloop.first %}active{% endif %}" 
                                                    id="sem-{{ academic_year.id }}-{{ year }}-{{ semester }}-tab" 
                                                    data-bs-toggle="pill" 
                                                    data-bs-target="#sem-{{ academic_year.id }}-{{ year }}-{{ semester }}" 
                                                    data-semester="{{ semester }}"
                                                    type="button" role="tab">
                                                Semester {{ semester }}
                                            </button>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    
                                    <div class="tab-content" id="semesterTabsContent-{{ academic_year.id }}-{{ year }}">
                                        {% for semester in programme_semesters %}
                                        <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
                                             id="sem-{{ academic_year.id }}-{{ year }}-{{ semester }}" 
                                             role="tabpanel">
                                            <div id="courses-container-{{ academic_year.id }}-{{ year }}-{{ semester }}">
                                                <!-- Courses will be loaded here via AJAX -->
                                                <div class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <p class="mt-2 text-muted">Loading courses...</p>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Course Detail Modal -->
<div class="modal fade" id="courseDetailModal" tabindex="-1" aria-labelledby="courseDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="courseDetailModalLabel">Course Students</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="courseDetailContent">
                <!-- Course detail content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <div class="btn-group">
                    <button type="button" class="btn btn-success" id="downloadEligibleBtn">
                        <i class="bi bi-download"></i> Download Eligible Students
                    </button>
                    <button type="button" class="btn btn-info" id="downloadAllBtn">
                        <i class="bi bi-download"></i> Download All Students
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentProgrammeId = {{ programme.id }};
    let currentAcademicYearId = null;
    let currentYear = null;
    let currentSemester = null;
    let currentCourseId = null;
    let currentSemesterId = null;
    
    // Initialize Bootstrap tabs and pills
    const tabElms = document.querySelectorAll('button[data-bs-toggle="tab"], button[data-bs-toggle="pill"]');
    tabElms.forEach(tabEl => {
        tabEl.addEventListener('click', function(event) {
            event.preventDefault();
            if (this.getAttribute('data-bs-toggle') === 'tab') {
                const tab = new bootstrap.Tab(this);
                tab.show();
            } else {
                const pill = new bootstrap.Tab(this);
                pill.show();
            }
        });
    });
    
    // Load data when academic year tab is clicked
    document.querySelectorAll('#academicYearTabs button[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function() {
            currentAcademicYearId = this.getAttribute('data-academic-year-id');
            loadActiveTabData();
        });
    });
    
    // Load data when programme year pill is clicked
    document.querySelectorAll('button[data-bs-toggle="pill"][data-year]').forEach(pill => {
        pill.addEventListener('shown.bs.tab', function() {
            currentYear = this.getAttribute('data-year');
            loadActiveTabData();
        });
    });
    
    // Load data when semester pill is clicked
    document.querySelectorAll('button[data-bs-toggle="pill"][data-semester]').forEach(pill => {
        pill.addEventListener('shown.bs.tab', function() {
            currentSemester = this.getAttribute('data-semester');
            loadActiveTabData();
        });
    });
    
    function loadActiveTabData() {
        if (!currentAcademicYearId || !currentYear || !currentSemester) return;
        
        const containerId = `courses-container-${currentAcademicYearId}-${currentYear}-${currentSemester}`;
        const container = document.getElementById(containerId);
        
        if (!container || container.getAttribute('data-loaded') === 'true') return;
        
        // Show loading
        container.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading courses...</p>
            </div>
        `;
        
        // Fetch course data
        fetch(`/exams/ajax/academic-year-courses/${currentProgrammeId}/${currentAcademicYearId}/${currentYear}/${currentSemester}/`)
            .then(response => response.json())
            .then(data => {
                displayCourses(container, data.courses, currentAcademicYearId, currentYear, currentSemester);
                container.setAttribute('data-loaded', 'true');
            })
            .catch(error => {
                console.error('Error loading courses:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Error loading courses. Please try again.
                    </div>
                `;
            });
    }
    
    function displayCourses(container, courses, academicYearId, year, semester) {
        if (courses.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-journal-x display-1 text-muted"></i>
                    <h5 class="text-muted mt-3">No Courses</h5>
                    <p class="text-muted">No courses found for Year ${year}, Semester ${semester}.</p>
                </div>
            `;
            return;
        }
        
        let html = '<div class="row">';
        
        courses.forEach(course => {
            const eligibilityPercentage = course.enrollment_count > 0 ? 
                Math.round((course.eligible_count / course.enrollment_count) * 100) : 0;
            
            html += `
                <div class="col-md-6 mb-3">
                    <div class="card h-100 course-card" data-course-id="${course.id}" data-semester-id="${container.id.split('-')[3]}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">${course.code}</h6>
                                <small class="text-muted">${course.name}</small>
                            </div>
                            <span class="badge bg-${course.course_type === 'Core' ? 'danger' : course.course_type === 'Elective' ? 'success' : 'secondary'}">
                                ${course.course_type}
                            </span>
                        </div>
                        <div class="card-body">
                            <div class="row text-center mb-3">
                                <div class="col-4">
                                    <h5 class="text-primary">${course.enrollment_count}</h5>
                                    <small class="text-muted">Total Students</small>
                                </div>
                                <div class="col-4">
                                    <h5 class="text-success">${course.eligible_count}</h5>
                                    <small class="text-muted">Eligible</small>
                                </div>
                                <div class="col-4">
                                    <h5 class="text-danger">${course.ineligible_count}</h5>
                                    <small class="text-muted">Ineligible</small>
                                </div>
                            </div>
                            
                            <div class="progress mb-3" style="height: 8px;">
                                <div class="progress-bar bg-success" style="width: ${eligibilityPercentage}%"></div>
                            </div>
                            <small class="text-muted">${eligibilityPercentage}% eligible for exams</small>
                            
                            <hr>
                            <p class="mb-2">
                                <i class="bi bi-award me-1"></i><strong>Credits:</strong> ${course.credit_hours}
                            </p>
                            <p class="mb-2">
                                <i class="bi bi-person-circle me-1"></i><strong>Lecturer:</strong> ${course.lecturer_name}
                            </p>
                        </div>
                        <div class="card-footer">
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary btn-sm view-students-btn" 
                                        data-course-id="${course.id}" 
                                        data-semester-id="${container.id.split('-')[3]}"
                                        data-course-name="${course.name}"
                                        data-course-code="${course.code}">
                                    <i class="bi bi-people me-1"></i>View Students
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
        
        // Attach event listeners to view students buttons
        container.querySelectorAll('.view-students-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const courseId = this.getAttribute('data-course-id');
                const semesterId = this.getAttribute('data-semester-id');
                const courseName = this.getAttribute('data-course-name');
                const courseCode = this.getAttribute('data-course-code');
                
                currentCourseId = courseId;
                currentSemesterId = semesterId;
                
                loadCourseStudents(courseId, semesterId, courseName, courseCode);
            });
        });
    }
    
    function loadCourseStudents(courseId, semesterId, courseName, courseCode) {
        const modal = new bootstrap.Modal(document.getElementById('courseDetailModal'));
        const modalTitle = document.getElementById('courseDetailModalLabel');
        const modalContent = document.getElementById('courseDetailContent');
        
        modalTitle.textContent = `${courseCode} - ${courseName} Students`;
        
        modalContent.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading student list...</p>
            </div>
        `;
        
        modal.show();
        
        // Load the course students page content
        fetch(`/exams/course-students/${currentProgrammeId}/${courseId}/${semesterId}/`)
            .then(response => response.text())
            .then(html => {
                // Extract the main content from the response
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const mainContent = doc.querySelector('.container');
                
                if (mainContent) {
                    modalContent.innerHTML = mainContent.innerHTML;
                } else {
                    modalContent.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('Error loading course students:', error);
                modalContent.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Error loading student list. Please try again.
                    </div>
                `;
            });
    }
    
    // Download buttons functionality
    document.getElementById('downloadEligibleBtn').addEventListener('click', function() {
        if (currentCourseId && currentSemesterId) {
            window.open(`/exams/download-eligible-students/${currentProgrammeId}/${currentCourseId}/${currentSemesterId}/`, '_blank');
        }
    });
    
    document.getElementById('downloadAllBtn').addEventListener('click', function() {
        if (currentCourseId && currentSemesterId) {
            window.open(`/exams/download-all-students/${currentProgrammeId}/${currentCourseId}/${currentSemesterId}/`, '_blank');
        }
    });
    
    // Initialize first tab on page load
    const firstAcademicYearTab = document.querySelector('#academicYearTabs button[data-bs-toggle="tab"]');
    if (firstAcademicYearTab) {
        currentAcademicYearId = firstAcademicYearTab.getAttribute('data-academic-year-id');
        currentYear = '1';
        currentSemester = '1';
        
        // Small delay to ensure DOM is ready
        setTimeout(() => {
            loadActiveTabData();
        }, 100);
    }
});
</script>

<style>
@media print {
    .btn, .nav-tabs, .nav-pills, .modal, .card-footer {
        display: none !important;
    }
    
    .onprintContainer {
        margin: 0 !important;
        padding: 0 !important;
    }
    
    .card {
        border: none !important;
        box-shadow: none !important;
        break-inside: avoid;
    }
    
    .tab-content {
        display: block !important;
    }
    
    .tab-pane {
        display: block !important;
        opacity: 1 !important;
    }
}

.course-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: pointer;
}

.course-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.nav-pills .nav-link {
    border-radius: 20px;
    margin-right: 5px;
}

.nav-pills.nav-sm .nav-link {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}

.progress {
    background-color: #e9ecef;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}

.badge {
    font-size: 0.75em;
}

/* Custom scrollbar for modal */
.modal-body {
    max-height: 70vh;
    overflow-y: auto;
}

.modal-body::-webkit-scrollbar {
    width: 6px;
}

.modal-body::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.modal-body::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
}

.modal-body::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* Tab content transitions */
.tab-pane {
    transition: opacity 0.3s ease;
}

.fade:not(.show) {
    opacity: 0;
}

.fade.show {
    opacity: 1;
}

/* Loading states */
.loading-overlay {
    position: relative;
}

.loading-overlay::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    z-index: 10;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .nav-tabs .nav-link {
        font-size: 0.875rem;
        padding: 0.5rem 0.75rem;
    }
    
    .nav-pills .nav-link {
        font-size: 0.8rem;
        padding: 0.375rem 0.5rem;
        margin-right: 3px;
    }
    
    .card-body .row.text-center h5 {
        font-size: 1rem;
    }
    
    .modal-dialog {
        margin: 0.5rem;
        max-width: calc(100% - 1rem);
    }
}

/* Animation for course cards */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.course-card {
    animation: fadeInUp 0.3s ease;
}

/* Status indicator colors */
.text-eligible {
    color: #28a745 !important;
}

.text-ineligible {
    color: #dc3545 !important;
}

.bg-eligible {
    background-color: #d4edda !important;
}

.bg-ineligible {
    background-color: #f8d7da !important;
}
</style>

{% endblock %}